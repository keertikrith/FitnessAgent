name: Send Daily Checkins & Report

on:
  schedule:
    # Check-ins at 9am, 12pm, 3pm, 6pm, 9pm UTC
    # Adjust the hour based on your timezone offset from UTC
    - cron: '0 9 * * *'   # 9am UTC
    - cron: '0 12 * * *'  # 12pm UTC
    - cron: '0 15 * * *'  # 3pm UTC
    - cron: '0 18 * * *'  # 6pm UTC
    - cron: '0 21 * * *'  # 9pm UTC
    - cron: '0 22 * * *'  # 10pm UTC (final report)
  workflow_dispatch:

jobs:
  send-checkin-or-report:
    runs-on: ubuntu-latest
    steps:
      - name: Determine endpoint
        id: endpoint
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "22" ]; then
            echo "endpoint=report" >> $GITHUB_OUTPUT
          else
            echo "endpoint=checkin" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --progress=false
          else
            npm install --no-audit --no-fund
          fi

      - name: Run check-in script
        if: steps.endpoint.outputs.endpoint == 'checkin'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM }}
          CHECKIN_USER_ID: ${{ secrets.CHECKIN_USER_ID }}
          CHECKIN_USER_PHONE: ${{ secrets.CHECKIN_USER_PHONE }}
          CHECKIN_TIMEZONE: ${{ secrets.CHECKIN_TIMEZONE }}
        run: |
          echo "Running check-in script at $(date -u)"
          node scripts/send_checkins.js

      - name: Run report script
        if: steps.endpoint.outputs.endpoint == 'report'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM }}
          CHECKIN_USER_ID: ${{ secrets.CHECKIN_USER_ID }}
          CHECKIN_USER_PHONE: ${{ secrets.CHECKIN_USER_PHONE }}
          CHECKIN_TIMEZONE: ${{ secrets.CHECKIN_TIMEZONE }}
        run: |
          echo "Running report script at $(date -u)"
          node scripts/send_report.js
